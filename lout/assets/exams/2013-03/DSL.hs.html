<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-20130316/DSL.hs</title>
</head>
<body>
<pre><font color=Blue>-- A DSL for symbolic algebra.</font>
<font color=Blue>{-# LANGUAGE GADTs #-}</font>
<u><font color="#804000">module</font></u> <font color=Green>DSL</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Maybe</font> <font color="#808080">(</font>isJust<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#808080">(</font>liftM<font color="#808080">,</font> liftM2<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font>

<font color=Blue>{- The |Num|, |Fractional| and |Floating| classes in Haskell provide an
API for several mathematical operations and the standard library
provides instances for several base types like integers, floating
point numbers and rationals. Your task here is to implement a DSL for
symbolic expressions for the following subset of this API: -}</font>

<font color=Blue>{- Task 2 (a) Implement a type |Sym v| as a deep embedding of the API
\&amp; symbolic variables of type |v|.  -}</font>

<u><font color="#804000">data</font></u> <font color=Green>Sym</font> v <u><font color="#804000">where</font></u>
  <font color=Green>Var</font>     <font color="#808080">::</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>    <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color="#808080">(</font><b><font color="#800080">:*</font></b><font color="#808080">)</font>    <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Negate</font>  <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Lit</font>     <font color="#808080">::</font> <font color=Green>Integer</font> <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color="#808080">(</font><b><font color="#800080">:/</font></b><font color="#808080">)</font>    <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Pi</font>      <font color="#808080">::</font> <font color=Green>Sym</font> v
  <font color=Green>Exp</font>     <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Log</font>     <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Sin</font>     <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
  <font color=Green>Cos</font>     <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v
    <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Eq</font><font color="#808080">,</font> <font color=Green>Show</font><font color="#808080">)</font>  <font color=Blue>-- not part of exam question</font>

<font color=Blue>{- Task 2 (b) Implement parts of a run function |eval :: Floating n =&gt;
(v -&gt; Maybe n) -&gt; Sym v -&gt; Maybe n|. It is enough to implement the
cases for variables, |(+)|, |negate|, |fromInteger|, |(/)| and |exp|.
-}</font>

eval <font color="#808080">::</font> <font color=Green>Floating</font> n <font color="#808080">=&gt;</font> <font color="#808080">(</font>v <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> n<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> n
eval lookup <font color="#808080">=</font> ev
  <u><font color="#804000">where</font></u>  ev <font color="#808080">(</font><font color=Green>Var</font> v<font color="#808080">)</font>     <font color="#808080">=</font> lookup v
         ev <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> liftM2  <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font>     <font color="#808080">(</font>ev e1<font color="#808080">)</font>  <font color="#808080">(</font>ev e2<font color="#808080">)</font>
         ev <font color="#808080">(</font><font color=Green>Negate</font> e<font color="#808080">)</font>  <font color="#808080">=</font> liftM   negate  <font color="#808080">(</font>ev e<font color="#808080">)</font>
         ev <font color="#808080">(</font><font color=Green>Lit</font> i<font color="#808080">)</font>     <font color="#808080">=</font> return  <font color="#808080">(</font>fromInteger i<font color="#808080">)</font>
         ev <font color="#808080">(</font>e1 <b><font color="#800080">:/</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> liftM2  <font color="#808080">(</font><font color="#800080">/</font><font color="#808080">)</font>     <font color="#808080">(</font>ev e1<font color="#808080">)</font>  <font color="#808080">(</font>ev e2<font color="#808080">)</font>
         ev <font color="#808080">(</font><font color=Green>Exp</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   exp     <font color="#808080">(</font>ev e<font color="#808080">)</font>
         <font color=Blue>-- end of required part</font>
         ev <font color="#808080">(</font>e1 <b><font color="#800080">:*</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> liftM2  <font color="#808080">(</font><font color="#800080">*</font><font color="#808080">)</font>     <font color="#808080">(</font>ev e1<font color="#808080">)</font>  <font color="#808080">(</font>ev e2<font color="#808080">)</font>
         ev <font color=Green>Pi</font>          <font color="#808080">=</font> return  pi
         ev <font color="#808080">(</font><font color=Green>Log</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   log     <font color="#808080">(</font>ev e<font color="#808080">)</font>
         ev <font color="#808080">(</font><font color=Green>Sin</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   sin     <font color="#808080">(</font>ev e<font color="#808080">)</font>
         ev <font color="#808080">(</font><font color=Green>Cos</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   cos     <font color="#808080">(</font>ev e<font color="#808080">)</font>


<font color=Blue>{- Task 2 (c): Implement an algebraic simplification function 
|simp :: Sym v -&gt; Maybe (Sym v)| which handles the rules |0 * x == 0|,
|sin pi == 0|, |log (exp x) == x| and which fails (with |Nothing|) on
division by zero.  -}</font>

simp <font color="#808080">::</font> <font color=Green>Sym</font> v <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color="#808080">(</font><font color=Green>Sym</font> v<font color="#808080">)</font>
simp <font color="#808080">(</font>e1 <b><font color="#800080">:*</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> <u><font color="#804000">do</font></u>  e1' <font color="#808080">&lt;-</font> simp e1
                       e2' <font color="#808080">&lt;-</font> simp e2
                       return <font color="#800080">$</font> <u><font color="#804000">case</font></u> e1' <u><font color="#804000">of</font></u>
                         <font color=Green>Lit</font> <font color=Magenta>0</font>  <font color="#808080">-&gt;</font> <font color=Green>Lit</font> <font color=Magenta>0</font>
                         <u><font color="#804000">_</font></u>      <font color="#808080">-&gt;</font> e1' <b><font color="#800080">:*</font></b> e2'
simp <font color="#808080">(</font><font color=Green>Sin</font> e<font color="#808080">)</font>     <font color="#808080">=</font> <u><font color="#804000">do</font></u>  e' <font color="#808080">&lt;-</font> simp e
                       return <font color="#800080">$</font> <u><font color="#804000">case</font></u> e' <u><font color="#804000">of</font></u>
                         <font color=Green>Pi</font>     <font color="#808080">-&gt;</font> <font color=Green>Lit</font> <font color=Magenta>0</font>
                         <u><font color="#804000">_</font></u>      <font color="#808080">-&gt;</font> <font color=Green>Sin</font> e'
simp <font color="#808080">(</font><font color=Green>Log</font> e<font color="#808080">)</font>     <font color="#808080">=</font> <u><font color="#804000">do</font></u>  e' <font color="#808080">&lt;-</font> simp e
                       return <font color="#800080">$</font> <u><font color="#804000">case</font></u> e' <u><font color="#804000">of</font></u>
                         <font color=Green>Exp</font> e2 <font color="#808080">-&gt;</font> e2
                         <u><font color="#804000">_</font></u>      <font color="#808080">-&gt;</font> <font color=Green>Log</font> e'
simp <font color="#808080">(</font>e1 <b><font color="#800080">:/</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> <u><font color="#804000">do</font></u>  e1' <font color="#808080">&lt;-</font> simp e1
                       e2' <font color="#808080">&lt;-</font> simp e2
                       <u><font color="#804000">case</font></u> e2' <u><font color="#804000">of</font></u>
                         <font color=Green>Lit</font> <font color=Magenta>0</font>  <font color="#808080">-&gt;</font> <font color=Green>Nothing</font>
                         <u><font color="#804000">_</font></u>      <font color="#808080">-&gt;</font> <font color=Green>Just</font> <font color="#800080">$</font> e1' <b><font color="#800080">:/</font></b> e2'
<font color=Blue>-- If no rule applies, just simplify recursively:</font>
simp <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font> liftM2  <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>    <font color="#808080">(</font>simp e1<font color="#808080">)</font>  <font color="#808080">(</font>simp e2<font color="#808080">)</font>
simp <font color="#808080">(</font><font color=Green>Negate</font> e<font color="#808080">)</font>  <font color="#808080">=</font> liftM   <font color=Green>Negate</font>  <font color="#808080">(</font>simp e<font color="#808080">)</font>
simp <font color="#808080">(</font><font color=Green>Exp</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   <font color=Green>Exp</font>     <font color="#808080">(</font>simp e<font color="#808080">)</font>
simp <font color="#808080">(</font><font color=Green>Cos</font> e<font color="#808080">)</font>     <font color="#808080">=</font> liftM   <font color=Green>Cos</font>     <font color="#808080">(</font>simp e<font color="#808080">)</font>
<font color=Blue>-- Base cases: Sym, Lit, Pi</font>
simp e           <font color="#808080">=</font> return e


<font color=Blue>-- Not part of the exam question:</font>
testrule1 <font color="#808080">::</font> <font color=Green>Sym</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Property</font>
testrule1 x  <font color="#808080">=</font> isJust <font color="#808080">(</font>simp x<font color="#808080">)</font>  <font color="#800080">==&gt;</font>  simp <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>0</font> <b><font color="#800080">:*</font></b> x<font color="#808080">)</font> <font color="#800080">==</font> <font color=Green>Just</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>0</font><font color="#808080">)</font>
testrule2    <font color="#808080">=</font> simp <font color="#808080">(</font><font color=Green>Sin</font> <font color=Green>Pi</font> <font color="#808080">::</font> <font color=Green>Sym</font> <font color=Green>Char</font><font color="#808080">)</font>  <font color="#800080">==</font> <font color=Green>Just</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>0</font><font color="#808080">)</font>
testrule3 <font color="#808080">::</font> <font color=Green>Sym</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
testrule3 x  <font color="#808080">=</font> simp <font color="#808080">(</font><font color=Green>Log</font> <font color="#808080">(</font><font color=Green>Exp</font> x<font color="#808080">)</font><font color="#808080">)</font>  <font color="#800080">==</font> simp x

<font color=Blue>{- Task 2 (d):   
  Is there a reasonable |Monad| instance for |Sym|? If so, implement
  |return| and sketch |(&gt;&gt;=)|, otherwise explain why not.
-}</font>

<font color=Blue>-- Yes, there is a reasonable Monad instance with (&gt;&gt;=) as substitution.</font>

<u><font color="#804000">instance</font></u> <font color=Green>Monad</font> <font color=Green>Sym</font> <u><font color="#804000">where</font></u>
  return  <font color="#808080">=</font> <font color=Green>Var</font>
  <font color="#808080">(</font><font color="#800080">&gt;&gt;=</font><font color="#808080">)</font>   <font color="#808080">=</font> bindSym
  
bindSym <font color="#808080">::</font> <font color=Green>Sym</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> <font color=Green>Sym</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Sym</font> b
bindSym <font color="#808080">(</font><font color=Green>Var</font> v<font color="#808080">)</font>     f  <font color="#808080">=</font> f v
bindSym <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>  f  <font color="#808080">=</font> <font color="#808080">(</font>bindSym e1 f<font color="#808080">)</font> <b><font color="#800080">:+</font></b> <font color="#808080">(</font>bindSym e2 f<font color="#808080">)</font>
bindSym <font color="#808080">(</font><font color=Green>Lit</font> i<font color="#808080">)</font>     f  <font color="#808080">=</font> <font color=Green>Lit</font> i
<font color=Blue>-- ... always apply bindSym recursively, details not needed for the exam</font>

<font color=Blue>----------------------------------------------------------------</font>
<font color=Blue>-- Utilities (not part of exam question)</font>
<u><font color="#804000">instance</font></u> <font color=Green>Arbitrary</font> v <font color="#808080">=&gt;</font> <font color=Green>Arbitrary</font> <font color="#808080">(</font><font color=Green>Sym</font> v<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  arbitrary  <font color="#808080">=</font> sized <font color="#808080">(</font>arbitrarySym arbitrary<font color="#808080">)</font>
<font color=Blue>--  shrink     = shrinkSym shrink </font>

arbitrarySym <font color="#808080">::</font> <font color=Green>Gen</font> v <font color="#808080">-&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Gen</font> <font color="#808080">(</font><font color=Green>Sym</font> v<font color="#808080">)</font>  
arbitrarySym g n <font color="#808080">|</font> n <font color="#800080">&lt;=</font> <font color=Magenta>0</font>     <font color="#808080">=</font> oneof <font color="#808080">[</font>liftM <font color=Green>Var</font> g<font color="#808080">,</font> liftM <font color=Green>Lit</font> arbitrary<font color="#808080">,</font> return <font color=Green>Pi</font><font color="#808080">]</font>
                 <font color="#808080">|</font> otherwise  <font color="#808080">=</font> oneof <font color="#808080">[</font>unary<font color="#808080">,</font> binary<font color="#808080">]</font>
  <u><font color="#804000">where</font></u> unary  <font color="#808080">=</font> <u><font color="#804000">do</font></u>  unop <font color="#808080">&lt;-</font> elements <font color="#808080">[</font><font color=Green>Negate</font><font color="#808080">,</font> <font color=Green>Exp</font><font color="#808080">,</font> <font color=Green>Log</font><font color="#808080">,</font> <font color=Green>Sin</font><font color="#808080">,</font> <font color=Green>Cos</font><font color="#808080">]</font>
                     liftM unop <font color="#808080">(</font>arbitrarySym g <font color="#808080">(</font>n<font color=Blue>-</font><font color=Magenta>1</font><font color="#808080">)</font><font color="#808080">)</font>
        binary <font color="#808080">=</font> <u><font color="#804000">do</font></u>  binop <font color="#808080">&lt;-</font> elements <font color="#808080">[</font><font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font><font color="#808080">,</font> <font color="#808080">(</font><b><font color="#800080">:*</font></b><font color="#808080">)</font><font color="#808080">,</font> <font color="#808080">(</font><b><font color="#800080">:/</font></b><font color="#808080">)</font><font color="#808080">]</font>
                     <u><font color="#804000">let</font></u> genHalfSize <font color="#808080">=</font> arbitrarySym g <font color="#808080">(</font>n <font color="#800080">`div`</font> <font color=Magenta>2</font><font color="#808080">)</font>
                     liftM2 binop genHalfSize genHalfSize

<font color=Blue>{-
shrinkSym :: (v -&gt; [v]) -&gt; (Sym v -&gt; [Sym v])
shrinkSym shr = error "TBD"
-}</font>
</pre>
</body>
</html>