<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-20100824/Expr.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GADTs #-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Char</font>
<u><font color="#804000">import</font></u> <font color=Green>Parser</font>

<font color=Blue>-- | A simple expression language with integers and booleans. Contains</font>
<font color=Blue>--   both well- and ill-typed expressions.</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  <font color=Green>LitN</font>  <font color="#808080">::</font> <font color=Green>Int</font>                           <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
  <font color=Green>LitB</font>  <font color="#808080">::</font> <font color=Green>Bool</font>                          <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
  <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>  <font color="#808080">::</font>         <font color=Green>Expr</font>      <font color="#808080">-&gt;</font> <font color=Green>Expr</font>     <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
  <font color="#808080">(</font><b><font color="#800080">:==</font></b><font color="#808080">)</font> <font color="#808080">::</font>         <font color=Green>Expr</font>      <font color="#808080">-&gt;</font> <font color=Green>Expr</font>     <font color="#808080">-&gt;</font> <font color=Green>Expr</font>
  <font color=Green>If</font>    <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font>      <font color="#808080">-&gt;</font> <font color=Green>Expr</font>     <font color="#808080">-&gt;</font> <font color=Green>Expr</font>

<font color=Blue>-- | A value is an integer or a boolean.</font>
<u><font color="#804000">data</font></u> <font color=Green>Value</font> <font color="#808080">=</font> <font color=Green>VInt</font> <font color=Green>Int</font> <font color="#808080">|</font> <font color=Green>VBool</font> <font color=Green>Bool</font>
  <u><font color="#804000">deriving</font></u> <font color=Green>Show</font>

<font color=Blue>-- | Evaluating expressions. Things are a bit complicated because we</font>
<font color=Blue>--   have to check that we get values of the right types for the</font>
<font color=Blue>--   operations. Fails if the evaluated expression isn't well-typed.</font>
eval <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Value</font>
eval <font color="#808080">(</font><font color=Green>LitN</font> n<font color="#808080">)</font>       <font color="#808080">=</font>  <font color=Green>VInt</font> n
eval <font color="#808080">(</font><font color=Green>LitB</font> b<font color="#808080">)</font>       <font color="#808080">=</font>  <font color=Green>VBool</font> b
eval <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>     <font color="#808080">=</font>  plus <font color="#808080">(</font>eval e1<font color="#808080">)</font> <font color="#808080">(</font>eval e2<font color="#808080">)</font>
  <u><font color="#804000">where</font></u> plus <font color="#808080">(</font><font color=Green>VInt</font> n<font color="#808080">)</font> <font color="#808080">(</font><font color=Green>VInt</font> m<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>VInt</font> <font color="#800080">$</font> n <font color="#800080">+</font> m
eval <font color="#808080">(</font>e1 <b><font color="#800080">:==</font></b> e2<font color="#808080">)</font>    <font color="#808080">=</font>  eq <font color="#808080">(</font>eval e1<font color="#808080">)</font> <font color="#808080">(</font>eval e2<font color="#808080">)</font>
  <u><font color="#804000">where</font></u> eq <font color="#808080">(</font><font color=Green>VInt</font> n<font color="#808080">)</font>  <font color="#808080">(</font><font color=Green>VInt</font> m<font color="#808080">)</font>  <font color="#808080">=</font> <font color=Green>VBool</font> <font color="#800080">$</font> n <font color="#800080">==</font> m
        eq <font color="#808080">(</font><font color=Green>VBool</font> a<font color="#808080">)</font> <font color="#808080">(</font><font color=Green>VBool</font> b<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>VBool</font> <font color="#800080">$</font> a <font color="#800080">==</font> b
eval <font color="#808080">(</font><font color=Green>If</font> e1 e2 e3<font color="#808080">)</font>  <font color="#808080">=</font>  <u><font color="#804000">case</font></u> eval e1 <u><font color="#804000">of</font></u>
  <font color=Green>VBool</font> <font color=Green>True</font>   <font color="#808080">-&gt;</font>  eval e2
  <font color=Green>VBool</font> <font color=Green>False</font>  <font color="#808080">-&gt;</font>  eval e3

eOK<font color="#808080">,</font> eBad  <font color="#808080">::</font> <font color=Green>Expr</font>
eOK  <font color="#808080">=</font> <font color=Green>If</font> <font color="#808080">(</font><font color=Green>LitB</font> <font color=Green>False</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitN</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitN</font> <font color=Magenta>2</font> <b><font color="#800080">:+</font></b> <font color=Green>LitN</font> <font color=Magenta>1736</font><font color="#808080">)</font>
eBad <font color="#808080">=</font> <font color=Green>If</font> <font color="#808080">(</font><font color=Green>LitB</font> <font color=Green>False</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitN</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitN</font> <font color=Magenta>2</font> <b><font color="#800080">:+</font></b> <font color=Green>LitB</font> <font color=Green>True</font><font color="#808080">)</font>

<font color=Blue>-- Pretty printing.</font>
<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  showsPrec p e <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
    <font color=Green>LitN</font> n       <font color="#808080">-&gt;</font> shows n

    <font color=Green>LitB</font> b       <font color="#808080">-&gt;</font> shows b

    e1 <b><font color="#800080">:+</font></b> e2     <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>2</font><font color="#808080">)</font> <font color="#800080">$</font>
      showsPrec <font color=Magenta>2</font> e1 <font color="#800080">.</font> showString <font color=Magenta>" + "</font> <font color="#800080">.</font> showsPrec <font color=Magenta>3</font> e2

    e1 <b><font color="#800080">:==</font></b> e2    <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#800080">$</font>
      showsPrec <font color=Magenta>2</font> e1 <font color="#800080">.</font> showString <font color=Magenta>" == "</font> <font color="#800080">.</font> showsPrec <font color=Magenta>2</font> e2

    <font color=Green>If</font> e1 e2 e3  <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>0</font><font color="#808080">)</font> <font color="#800080">$</font>
      showString <font color=Magenta>"if "</font>    <font color="#800080">.</font> shows e1 <font color="#800080">.</font>
      showString <font color=Magenta>" then "</font> <font color="#800080">.</font> shows e2 <font color="#800080">.</font>
      showString <font color=Magenta>" else "</font> <font color="#800080">.</font> shows e3

<font color=Blue>-- Parsing expressions. Uses a slightly modified version of our parser</font>
<font color=Blue>-- library from lecture 4. Also goes crazy with the operators from</font>
<font color=Blue>-- "Control.Applicative".  Exercise: check out these combinators.</font>
<u><font color="#804000">type</font></u> <font color=Green>Token</font> <font color="#808080">=</font> <font color=Green>String</font>
<u><font color="#804000">instance</font></u> <font color=Green>Read</font> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  readsPrec p s <font color="#808080">=</font>
      <font color="#808080">[</font> <font color="#808080">(</font>x<font color="#808080">,</font> unwords ts<font color="#808080">)</font> <font color="#808080">|</font> <font color="#808080">(</font>x<font color="#808080">,</font> ts<font color="#808080">)</font> <font color="#808080">&lt;-</font> parse <font color="#808080">(</font>exprP p<font color="#808080">)</font> <font color="#800080">$</font> tokenize s <font color="#808080">]</font>
    <u><font color="#804000">where</font></u>
      tokenize <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font><font color=Green>Token</font><font color="#808080">]</font>
      tokenize <font color=Magenta>""</font> <font color="#808080">=</font> <font color=Green>[]</font>
      tokenize s  <font color="#808080">=</font> t <b><font color="#800080">:</font></b> tokenize s'
        <u><font color="#804000">where</font></u> <font color="#808080">[</font><font color="#808080">(</font>t<font color="#808080">,</font> s'<font color="#808080">)</font><font color="#808080">]</font> <font color="#808080">=</font> lex s

      exprP <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>P</font> <font color=Green>Token</font> <font color=Green>Expr</font>
      exprP <font color=Magenta>0</font> <font color="#808080">=</font> <font color=Green>If</font> <font color="#800080">&lt;$&gt;</font> <font color="#808080">(</font>this <font color=Magenta>"if"</font>   <font color="#800080">*&gt;</font> exprP <font color=Magenta>0</font><font color="#808080">)</font>
                   <font color="#800080">&lt;*&gt;</font> <font color="#808080">(</font>this <font color=Magenta>"then"</font> <font color="#800080">*&gt;</font> exprP <font color=Magenta>0</font><font color="#808080">)</font>
                   <font color="#800080">&lt;*&gt;</font> <font color="#808080">(</font>this <font color=Magenta>"else"</font> <font color="#800080">*&gt;</font> exprP <font color=Magenta>0</font><font color="#808080">)</font>
            <font color="#800080">&lt;|&gt;</font> exprP <font color=Magenta>1</font>

      exprP <font color=Magenta>1</font> <font color="#808080">=</font> <font color="#808080">(</font><b><font color="#800080">:==</font></b><font color="#808080">)</font> <font color="#800080">&lt;$&gt;</font> exprP <font color=Magenta>2</font> <font color="#800080">&lt;*&gt;</font> <font color="#808080">(</font>this <font color=Magenta>"=="</font> <font color="#800080">*&gt;</font> exprP <font color=Magenta>2</font><font color="#808080">)</font>
            <font color="#800080">&lt;|&gt;</font> exprP <font color=Magenta>2</font>

      exprP <font color=Magenta>2</font> <font color="#808080">=</font> chainLeft plusP <font color="#808080">(</font>exprP <font color=Magenta>3</font><font color="#808080">)</font>
        <u><font color="#804000">where</font></u> plusP <font color="#808080">=</font> <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font> <font color="#800080">&lt;$</font> this <font color=Magenta>"+"</font>

      exprP <u><font color="#804000">_</font></u> <font color="#808080">=</font> foldr1 <font color="#808080">(</font><font color="#800080">&lt;|&gt;</font><font color="#808080">)</font>
        <font color="#808080">[</font> <font color=Green>LitN</font> <font color="#800080">.</font> read  <font color="#800080">&lt;$&gt;</font>  sat <font color="#808080">(</font>all isDigit<font color="#808080">)</font>
        <font color="#808080">,</font> <font color=Green>LitB</font> <font color="#800080">.</font> read  <font color="#800080">&lt;$&gt;</font>  sat <font color="#808080">(</font><font color="#800080">`elem`</font> <font color="#808080">[</font><font color=Magenta>"True"</font><font color="#808080">,</font> <font color=Magenta>"False"</font><font color="#808080">]</font><font color="#808080">)</font>
        <font color="#808080">,</font> this <font color=Magenta>"("</font> <font color="#800080">*&gt;</font> exprP <font color=Magenta>0</font> <font color="#800080">&lt;*</font> this <font color=Magenta>")"</font>
        <font color="#808080">]</font>

</pre>
</body>
</html>