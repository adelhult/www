<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-20100824/Parser.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GADTs #-}</font>

<u><font color="#804000">module</font></u> <font color=Green>Parser</font>
  <font color="#808080">(</font> <font color=Green>P</font><font color="#808080">,</font> parse
  <font color="#808080">,</font> symbol<font color="#808080">,</font> pfail<font color="#808080">,</font> <font color="#808080">(</font><font color="#800080">+++</font><font color="#808080">)</font>
  <font color="#808080">,</font> this<font color="#808080">,</font> sat<font color="#808080">,</font> chainLeft
  <font color="#808080">)</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>

<u><font color="#804000">type</font></u> <font color=Green>ParseResult</font> s a <font color="#808080">=</font> <font color="#808080">[</font><font color="#808080">(</font>a<font color="#808080">,</font> <font color="#808080">[</font>s<font color="#808080">]</font><font color="#808080">)</font><font color="#808080">]</font>

<u><font color="#804000">data</font></u> <font color=Green>P</font> s a <u><font color="#804000">where</font></u>
  <font color=Green>Fail</font>   <font color="#808080">::</font> <font color=Green>P</font> s a
  <font color=Blue>-- ReturnChoice x p = return x +++ p</font>
  <font color=Green>ReturnChoice</font> <font color="#808080">::</font> a <font color="#808080">-&gt;</font> <font color=Green>P</font> s a <font color="#808080">-&gt;</font> <font color=Green>P</font> s a
  <font color=Blue>-- SymbolBind f = symbol &gt;&gt;= f</font>
  <font color=Green>SymbolBind</font> <font color="#808080">::</font> <font color="#808080">(</font>s <font color="#808080">-&gt;</font> <font color=Green>P</font> s a<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>P</font> s a

symbol <font color="#808080">=</font> <font color=Green>SymbolBind</font> return
pfail  <font color="#808080">=</font> <font color=Green>Fail</font>

<font color=Green>SymbolBind</font> f <font color="#800080">+++</font> <font color=Green>SymbolBind</font> g <font color="#808080">=</font> <font color=Green>SymbolBind</font> <font color="#808080">(</font><font color="#808080">\</font>x <font color="#808080">-&gt;</font> f x <font color="#800080">+++</font> g x<font color="#808080">)</font>
<font color=Green>Fail</font> <font color="#800080">+++</font> q  <font color="#808080">=</font> q
p <font color="#800080">+++</font> <font color=Green>Fail</font>  <font color="#808080">=</font> p
<font color=Green>ReturnChoice</font> x p <font color="#800080">+++</font> q <font color="#808080">=</font> <font color=Green>ReturnChoice</font> x <font color="#808080">(</font>p <font color="#800080">+++</font> q<font color="#808080">)</font>
p <font color="#800080">+++</font> <font color=Green>ReturnChoice</font> x q <font color="#808080">=</font> <font color=Green>ReturnChoice</font> x <font color="#808080">(</font>p <font color="#800080">+++</font> q<font color="#808080">)</font>

<u><font color="#804000">instance</font></u> <font color=Green>Monad</font> <font color="#808080">(</font><font color=Green>P</font> s<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  return x <font color="#808080">=</font> <font color=Green>ReturnChoice</font> x pfail
  <font color=Green>Fail</font>             <font color="#800080">&gt;&gt;=</font> f <font color="#808080">=</font> <font color=Green>Fail</font>
  <font color=Green>ReturnChoice</font> x p <font color="#800080">&gt;&gt;=</font> f <font color="#808080">=</font> f x <font color="#800080">+++</font> <font color="#808080">(</font>p <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font>
  <font color=Green>SymbolBind</font> k     <font color="#800080">&gt;&gt;=</font> f <font color="#808080">=</font> <font color=Green>SymbolBind</font> <font color="#808080">(</font><font color="#808080">\</font>x <font color="#808080">-&gt;</font> k x <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font>

<u><font color="#804000">instance</font></u> <font color=Green>Functor</font> <font color="#808080">(</font><font color=Green>P</font> s<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  fmap <font color="#808080">=</font> liftM

<u><font color="#804000">instance</font></u> <font color=Green>Applicative</font> <font color="#808080">(</font><font color=Green>P</font> s<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  pure <font color="#808080">=</font> return
  <font color="#808080">(</font><font color="#800080">&lt;*&gt;</font><font color="#808080">)</font> <font color="#808080">=</font> ap

<u><font color="#804000">instance</font></u> <font color=Green>Alternative</font> <font color="#808080">(</font><font color=Green>P</font> s<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  empty <font color="#808080">=</font> pfail
  <font color="#808080">(</font><font color="#800080">&lt;|&gt;</font><font color="#808080">)</font> <font color="#808080">=</font> <font color="#808080">(</font><font color="#800080">+++</font><font color="#808080">)</font>

parse <font color="#808080">::</font> <font color=Green>P</font> s a <font color="#808080">-&gt;</font> <font color="#808080">[</font>s<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>ParseResult</font> s a
parse <font color="#808080">(</font><font color=Green>SymbolBind</font> f<font color="#808080">)</font> <font color="#808080">(</font>c <b><font color="#800080">:</font></b> s<font color="#808080">)</font> <font color="#808080">=</font> parse <font color="#808080">(</font>f c<font color="#808080">)</font> s
parse <font color="#808080">(</font><font color=Green>SymbolBind</font> f<font color="#808080">)</font> <font color=Green>[]</font>      <font color="#808080">=</font> <font color=Green>[]</font>
parse <font color=Green>Fail</font>       <u><font color="#804000">_</font></u>           <font color="#808080">=</font> <font color=Green>[]</font>
parse <font color="#808080">(</font><font color=Green>ReturnChoice</font> x p<font color="#808080">)</font> s   <font color="#808080">=</font> <font color="#808080">(</font>x<font color="#808080">,</font> s<font color="#808080">)</font> <b><font color="#800080">:</font></b> parse p s

<font color=Blue>-- Derived combinators</font>

sat <font color="#808080">::</font> <font color="#808080">(</font>s <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>P</font> s s
sat p <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  t <font color="#808080">&lt;-</font> symbol
  <u><font color="#804000">if</font></u> p t <u><font color="#804000">then</font></u> return t
         <u><font color="#804000">else</font></u> pfail

this <font color="#808080">::</font> <font color=Green>Eq</font> s <font color="#808080">=&gt;</font> s <font color="#808080">-&gt;</font> <font color=Green>P</font> s s
this x <font color="#808080">=</font> sat <font color="#808080">(</font>x <font color="#800080">==</font><font color="#808080">)</font>

chainLeft <font color="#808080">::</font> <font color=Green>P</font> s <font color="#808080">(</font>a <font color="#808080">-&gt;</font> a <font color="#808080">-&gt;</font> a<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>P</font> s a <font color="#808080">-&gt;</font> <font color=Green>P</font> s a
chainLeft op term <font color="#808080">=</font> <u><font color="#804000">do</font></u>
    e <font color="#808080">&lt;-</font> term
    chain e
  <u><font color="#804000">where</font></u>
    chain e <font color="#808080">=</font> return e <font color="#800080">+++</font> <u><font color="#804000">do</font></u>
      o  <font color="#808080">&lt;-</font> op
      e' <font color="#808080">&lt;-</font> term
      chain <font color="#808080">(</font>e <font color="#800080">`o`</font> e'<font color="#808080">)</font>

</pre>
</body>
</html>