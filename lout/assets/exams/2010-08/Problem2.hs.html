<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-20100824/Problem2.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GADTs, ExistentialQuantification #-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Typed</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Expr</font> <u><font color="#804000">as</font></u> <font color=Green>E</font>
<u><font color="#804000">import</font></u> <font color=Green>Maybe</font> <font color="#808080">(</font>fromJust<font color="#808080">)</font>

<u><font color="#804000">data</font></u> <font color=Green>Expr</font> t <u><font color="#804000">where</font></u>
  <font color=Green>Lit</font>   <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> t<font color="#808080">,</font> <font color=Green>Show</font> t<font color="#808080">)</font> <font color="#808080">=&gt;</font> t                     <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t
  <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>  <font color="#808080">::</font>                   <font color=Green>Expr</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Int</font>  <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Int</font>
  <font color="#808080">(</font><b><font color="#800080">:==</font></b><font color="#808080">)</font> <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> t<font color="#808080">,</font> <font color=Green>Show</font> t<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color=Green>Expr</font> t   <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t    <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Bool</font>
  <font color=Green>If</font>    <font color="#808080">::</font>      <font color=Green>Expr</font> <font color=Green>Bool</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t   <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t    <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t    <font color=Blue>-- ADDED a)</font>

eval <font color="#808080">::</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> t
eval <font color="#808080">(</font><font color=Green>Lit</font> x<font color="#808080">)</font>       <font color="#808080">=</font> x
eval <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>    <font color="#808080">=</font> eval e1 <font color="#800080">+</font> eval e2
eval <font color="#808080">(</font>e1 <b><font color="#800080">:==</font></b> e2<font color="#808080">)</font>   <font color="#808080">=</font> eval e1 <font color="#800080">==</font> eval e2
eval <font color="#808080">(</font><font color=Green>If</font> e1 e2 e3<font color="#808080">)</font> <font color="#808080">=</font> <u><font color="#804000">if</font></u> eval e1 <u><font color="#804000">then</font></u> eval e2 <u><font color="#804000">else</font></u> eval e3       <font color=Blue>-- ADDED b)</font>

eOK <font color="#808080">::</font> <font color=Green>Expr</font> <font color=Green>Int</font>
eOK  <font color="#808080">=</font> <font color=Green>If</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Green>False</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>2</font> <b><font color="#800080">:+</font></b> <font color=Green>Lit</font> <font color=Magenta>1736</font><font color="#808080">)</font>

<u><font color="#804000">data</font></u> <font color=Green>Type</font> t <u><font color="#804000">where</font></u>
  <font color=Green>TInt</font>  <font color="#808080">::</font> <font color=Green>Type</font> <font color=Green>Int</font>
  <font color=Green>TBool</font> <font color="#808080">::</font> <font color=Green>Type</font> <font color=Green>Bool</font>

<u><font color="#804000">data</font></u> <font color=Green>TypedExpr</font> <font color="#808080">=</font> <u><font color="#804000">forall</font></u> t<font color="#800080">.</font> <font color="#808080">(</font><font color=Green>Eq</font> t<font color="#808080">,</font> <font color=Green>Show</font> t<font color="#808080">)</font> <font color="#808080">=&gt;</font>   <font color=Green>Expr</font> t <b><font color="#800080">:::</font></b> <font color=Green>Type</font> t

<u><font color="#804000">data</font></u> <font color=Green>Equal</font> a b <u><font color="#804000">where</font></u>
  <font color=Green>Refl</font> <font color="#808080">::</font> <font color=Green>Equal</font> a a

<font color=Blue>-- | The type comparison function returns a proof that the types we</font>
<font color=Blue>--   compare are equal in the cases that they are.</font>
<font color="#808080">(</font><font color="#800080">=?=</font><font color="#808080">)</font> <font color="#808080">::</font> <font color=Green>Type</font> s <font color="#808080">-&gt;</font> <font color=Green>Type</font> t <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color="#808080">(</font><font color=Green>Equal</font> s t<font color="#808080">)</font>
<font color=Green>TInt</font>  <font color="#800080">=?=</font> <font color=Green>TInt</font>  <font color="#808080">=</font> <font color=Green>Just</font> <font color=Green>Refl</font>
<font color=Green>TBool</font> <font color="#800080">=?=</font> <font color=Green>TBool</font> <font color="#808080">=</font> <font color=Green>Just</font> <font color=Green>Refl</font>
<u><font color="#804000">_</font></u>     <font color="#800080">=?=</font> <u><font color="#804000">_</font></u>     <font color="#808080">=</font> <font color=Green>Nothing</font>

infer <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color=Green>TypedExpr</font>
infer e <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
  <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitN</font> n <font color="#808080">-&gt;</font> return <font color="#808080">(</font><font color=Green>Lit</font> n <b><font color="#800080">:::</font></b> <font color=Green>TInt</font><font color="#808080">)</font>

  <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitB</font> b <font color="#808080">-&gt;</font> return <font color="#808080">(</font><font color=Green>Lit</font> b <b><font color="#800080">:::</font></b> <font color=Green>TBool</font><font color="#808080">)</font>

  r1 <font color=Green>E</font><font color="#800080">.:+</font> r2 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
    e1 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font>  <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font>  <font color="#808080">&lt;-</font>  infer r2
    return <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font><font color="#808080">)</font>

  r1 <font color=Green>E</font><font color="#800080">.:==</font> r2 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
    e1 <b><font color="#800080">:::</font></b> t1    <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> t2    <font color="#808080">&lt;-</font>  infer r2
    <font color=Green>Refl</font>         <font color="#808080">&lt;-</font>  t1 <font color="#800080">=?=</font> t2
    return <font color="#808080">(</font>e1 <b><font color="#800080">:==</font></b> e2 <b><font color="#800080">:::</font></b> <font color=Green>TBool</font><font color="#808080">)</font>

  <font color=Green>E</font><font color="#800080">.</font><font color=Green>If</font> r1 r2 r3 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>                                           <font color=Blue>-- ADDED c)</font>
    e1 <b><font color="#800080">:::</font></b> <font color=Green>TBool</font> <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> t2    <font color="#808080">&lt;-</font>  infer r2
    e3 <b><font color="#800080">:::</font></b> t3    <font color="#808080">&lt;-</font>  infer r3
    <font color=Green>Refl</font>         <font color="#808080">&lt;-</font>  t2 <font color="#800080">=?=</font> t3
    return <font color="#808080">(</font><font color=Green>If</font> e1 e2 e3 <b><font color="#800080">:::</font></b> t2<font color="#808080">)</font>

check <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Type</font> t <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color="#808080">(</font><font color=Green>Expr</font> t<font color="#808080">)</font>
check r t <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  e <b><font color="#800080">:::</font></b> t' <font color="#808080">&lt;-</font> infer r
  <font color=Green>Refl</font>     <font color="#808080">&lt;-</font> t' <font color="#800080">=?=</font> t
  return e

test1R <font color="#808080">=</font> read <font color=Magenta>"1+2 == 3"</font>
test1  <font color="#808080">=</font> <font color=Green>Maybe</font><font color="#800080">.</font>fromJust <font color="#808080">(</font>infer test1R<font color="#808080">)</font>

<u><font color="#804000">infixl</font></u> <font color=Magenta>6</font> <b><font color="#800080">:+</font></b>
<u><font color="#804000">infix</font></u>  <font color=Magenta>4</font> <b><font color="#800080">:==</font></b>
<u><font color="#804000">infix</font></u>  <font color=Magenta>0</font> <b><font color="#800080">:::</font></b>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color="#808080">(</font><font color=Green>Type</font> t<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  show <font color=Green>TInt</font>  <font color="#808080">=</font> <font color=Magenta>"Int"</font>
  show <font color=Green>TBool</font> <font color="#808080">=</font> <font color=Magenta>"Bool"</font>
<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color=Green>TypedExpr</font> <u><font color="#804000">where</font></u>
  show <font color="#808080">(</font>e <b><font color="#800080">:::</font></b> t<font color="#808080">)</font> <font color="#808080">=</font> show e <font color="#800080">++</font> <font color=Magenta>" :: "</font> <font color="#800080">++</font> show t

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> t <font color="#808080">=&gt;</font> <font color=Green>Show</font> <font color="#808080">(</font><font color=Green>Expr</font> t<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  showsPrec <font color="#808080">=</font> showsPrecExpr

showsPrecExpr <font color="#808080">::</font> <font color=Green>Show</font> t <font color="#808080">=&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> <font color=Green>ShowS</font>               <font color=Blue>-- ADDED d)</font>
showsPrecExpr p e <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
    <font color=Green>Lit</font> n       <font color="#808080">-&gt;</font> shows n

    e1 <b><font color="#800080">:+</font></b> e2     <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>2</font><font color="#808080">)</font> <font color="#800080">$</font>
      showsPrec <font color=Magenta>2</font> e1 <font color="#800080">.</font> showString <font color=Magenta>" + "</font> <font color="#800080">.</font> showsPrec <font color=Magenta>3</font> e2

    e1 <b><font color="#800080">:==</font></b> e2    <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#800080">$</font>
      showsPrec <font color=Magenta>2</font> e1 <font color="#800080">.</font> showString <font color=Magenta>" == "</font> <font color="#800080">.</font> showsPrec <font color=Magenta>2</font> e2

    <font color=Green>If</font> e1 e2 e3  <font color="#808080">-&gt;</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>0</font><font color="#808080">)</font> <font color="#800080">$</font>                         <font color=Blue>-- ADDED d)</font>
      showString <font color=Magenta>"if "</font>    <font color="#800080">.</font> shows e1 <font color="#800080">.</font>
      showString <font color=Magenta>" then "</font> <font color="#800080">.</font> shows e2 <font color="#800080">.</font>
      showString <font color=Magenta>" else "</font> <font color="#800080">.</font> shows e3
</pre>
</body>
</html>