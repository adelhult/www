<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-09mar/Problem5.hs</title>
</head>
<body>
<pre>
<u><font color="#804000">module</font></u> <font color=Green>Problem5</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Concurrent</font><font color="#800080">.</font><font color=Green>STM</font>

<u><font color="#804000">data</font></u> <font color=Green>LockState</font> <font color="#808080">=</font> <font color=Green>Locked</font> <font color="#808080">|</font> <font color=Green>Unlocked</font>
<u><font color="#804000">type</font></u> <font color=Green>Lock</font> <font color="#808080">=</font> <font color=Green>TVar</font> <font color=Green>LockState</font>

<font color=Blue>-- a)</font>

newLock <font color="#808080">::</font> <font color=Green>STM</font> <font color=Green>Lock</font>
newLock <font color="#808080">=</font> newTVar <font color=Green>Unlocked</font>

lock <font color="#808080">::</font> <font color=Green>Lock</font> <font color="#808080">-&gt;</font> <font color=Green>STM</font> <font color=Green>()</font>
lock l <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  s <font color="#808080">&lt;-</font> readTVar l
  <u><font color="#804000">case</font></u> s <u><font color="#804000">of</font></u>
    <font color=Green>Locked</font>   <font color="#808080">-&gt;</font> retry
    <font color=Green>Unlocked</font> <font color="#808080">-&gt;</font> writeTVar l <font color=Green>Locked</font>

unlock <font color="#808080">::</font> <font color=Green>Lock</font> <font color="#808080">-&gt;</font> <font color=Green>STM</font> <font color=Green>()</font>
unlock l <font color="#808080">=</font> writeTVar l <font color=Green>Unlocked</font>

<font color=Blue>-- b)</font>

criticalSection <font color="#808080">::</font> <font color=Green>Lock</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> a <font color="#808080">-&gt;</font> <font color=Green>IO</font> a
criticalSection l m <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  atomically <font color="#800080">$</font> lock l
  x <font color="#808080">&lt;-</font> m
  atomically <font color="#800080">$</font> unlock l
  return x

<font color=Blue>-- c)</font>

lockAny <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Lock</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>STM</font> <font color=Green>Lock</font>
lockAny <font color=Green>[]</font> <font color="#808080">=</font> retry
lockAny <font color="#808080">(</font>l<b><font color="#800080">:</font></b>ls<font color="#808080">)</font> <font color="#808080">=</font>
  <u><font color="#804000">do</font></u> lock l
     return l
  <font color="#800080">`orElse`</font>
     lockAny ls

</pre>
</body>
</html>