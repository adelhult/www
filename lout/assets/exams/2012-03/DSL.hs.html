<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>exam-20120307/DSL.hs</title>
</head>
<body>
<pre><u><font color="#804000">module</font></u> <font color=Green>DSL</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font> <font color="#808080">(</font>pure<font color="#808080">,</font> <font color="#808080">(</font><font color="#800080">&lt;$&gt;</font><font color="#808080">)</font><font color="#808080">,</font> <font color="#808080">(</font><font color="#800080">&lt;*&gt;</font><font color="#808080">)</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Monoid</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>List</font><font color="#808080">(</font>sortBy<font color="#808080">,</font> sort<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font> <font color=Blue>-- not needed for the exam question</font>

<font color=Blue>-- Exam question code:</font>
empty    <font color="#808080">::</font> <font color=Green>Doc</font>
char     <font color="#808080">::</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font>
text     <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font>
line     <font color="#808080">::</font> <font color=Green>Doc</font>                <font color=Blue>-- newline</font>
<font color="#808080">(</font><font color="#800080">&lt;&gt;</font><font color="#808080">)</font>     <font color="#808080">::</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font>  <font color=Blue>-- append</font>
union    <font color="#808080">::</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font>  <font color=Blue>-- a choice of two variants only differing in layout</font>
prettys  <font color="#808080">::</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font><font color=Green>String</font><font color="#808080">]</font>

d1 <font color="#808080">=</font> union  <font color="#808080">(</font>text <font color=Magenta>"x&lt;-m"</font><font color="#808080">)</font> <font color="#808080">(</font>text <font color=Magenta>"x &lt;- m"</font><font color="#808080">)</font>
d2 <font color="#808080">=</font> union  <font color="#808080">(</font>text <font color=Magenta>"do {"</font>  <font color="#800080">&lt;&gt;</font> d1 <font color="#800080">&lt;&gt;</font> char <font color=Magenta>';'</font> <font color="#800080">&lt;&gt;</font> text <font color=Magenta>"f x}"</font><font color="#808080">)</font> 
            <font color="#808080">(</font>text <font color=Magenta>"do "</font>   <font color="#800080">&lt;&gt;</font> d1 <font color="#800080">&lt;&gt;</font> line <font color="#800080">&lt;&gt;</font>  text <font color=Magenta>"   f x"</font> <font color="#808080">)</font>

<font color=Blue>-- Task (a): Implementation</font>
<u><font color="#804000">data</font></u> <font color=Green>Doc</font> <font color="#808080">=</font> <font color=Green>Empty</font> <font color="#808080">|</font> <font color=Green>Char</font> <font color=Green>Char</font> <font color="#808080">|</font> <font color=Green>Text</font> <font color=Green>String</font> <font color="#808080">|</font> <font color=Green>Line</font> 
         <font color="#808080">|</font> <font color=Green>Concat</font> <font color=Green>Doc</font> <font color=Green>Doc</font> <font color="#808080">|</font> <font color=Green>Union</font> <font color=Green>Doc</font> <font color=Green>Doc</font> 
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Show</font><font color="#808080">,</font> <font color=Green>Eq</font><font color="#808080">)</font>
empty <font color="#808080">=</font> <font color=Green>Empty</font>
char <font color="#808080">=</font> <font color=Green>Char</font>
text <font color="#808080">=</font> <font color=Green>Text</font>
line <font color="#808080">=</font> <font color=Green>Line</font>
<font color="#808080">(</font><font color="#800080">&lt;&gt;</font><font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>Concat</font>
union <font color="#808080">=</font> <font color=Green>Union</font>

<font color=Blue>-- Note that lists form a Monad</font>
prettys <font color="#808080">(</font><font color=Green>Empty</font><font color="#808080">)</font>       <font color="#808080">=</font>  return <font color=Magenta>""</font>
prettys <font color="#808080">(</font><font color=Green>Char</font> c<font color="#808080">)</font>      <font color="#808080">=</font>  return <font color="#808080">(</font>c<b><font color="#800080">:</font></b><font color=Green>[]</font><font color="#808080">)</font>
prettys <font color="#808080">(</font><font color=Green>Text</font> s<font color="#808080">)</font>      <font color="#808080">=</font>  return s
prettys <font color="#808080">(</font><font color=Green>Line</font><font color="#808080">)</font>        <font color="#808080">=</font>  return <font color=Magenta>"\n"</font>
prettys <font color="#808080">(</font><font color=Green>Concat</font> x y<font color="#808080">)</font>  <font color="#808080">=</font>  sortBy cmp <font color="#800080">$</font> liftM2 <font color="#808080">(</font><font color="#800080">++</font><font color="#808080">)</font> <font color="#808080">(</font>prettys x<font color="#808080">)</font> <font color="#808080">(</font>prettys y<font color="#808080">)</font>
prettys <font color="#808080">(</font><font color=Green>Union</font>  x y<font color="#808080">)</font>  <font color="#808080">=</font>  mergeOn width <font color="#808080">(</font>prettys x<font color="#808080">)</font> <font color="#808080">(</font>prettys y<font color="#808080">)</font>

cmp <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Ordering</font>
cmp xs ys <font color="#808080">=</font> compare <font color="#808080">(</font>width xs<font color="#808080">)</font> <font color="#808080">(</font>width ys<font color="#808080">)</font>

<u><font color="#804000">type</font></u> <font color=Green>Width</font> <font color="#808080">=</font> <font color=Green>Int</font>
width <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Int</font>
width <font color=Magenta>""</font> <font color="#808080">=</font> <font color=Magenta>0</font>
width s <font color="#808080">=</font> maximum <font color="#800080">$</font> map length <font color="#800080">$</font> lines s

mergeOn <font color="#808080">::</font> <font color=Green>Ord</font> a <font color="#808080">=&gt;</font> <font color="#808080">(</font>t <font color="#808080">-&gt;</font> a<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font>t<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font>t<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font>t<font color="#808080">]</font>
mergeOn f <font color=Green>[]</font> ys <font color="#808080">=</font> ys
mergeOn f xs <font color=Green>[]</font> <font color="#808080">=</font> xs
mergeOn f <font color="#808080">(</font>x<b><font color="#800080">:</font></b>xs<font color="#808080">)</font> <font color="#808080">(</font>y<b><font color="#800080">:</font></b>ys<font color="#808080">)</font>  <font color="#808080">|</font> f x <font color="#800080">&lt;=</font> f y  <font color="#808080">=</font>  x <b><font color="#800080">:</font></b> mergeOn f xs <font color="#808080">(</font>y<b><font color="#800080">:</font></b>ys<font color="#808080">)</font>
                         <font color="#808080">|</font> otherwise   <font color="#808080">=</font>  y <b><font color="#800080">:</font></b> mergeOn f <font color="#808080">(</font>x<b><font color="#800080">:</font></b>xs<font color="#808080">)</font> ys
                                         
<font color=Blue>-- Task (b): Discussion</font>
<font color=Blue>{-
Is your implementation deep or shallow? 

This implementation is deep. The constructors are trivial and the run
function |prettys| is doing all of the work.

Are you using any monads (explain)? 

The run function is using the list monad as a way of simulating a
non-deterministic choice of several alternatives. 

Would some of the API operations fit the |Monoid| type class
(explain)?

It seems natural to have (Doc, empty, (&lt;&gt;)) as a Monoid. We just have
to be careful with what equality means - for the above implementation
with "derived" Eq the laws don't hold. 

One way around it is to use "smart" constructors instead - the
smartapp below solves the first two monoid laws, but not the third.

Another way is to compare the semantics. Then we don't need any smart
constructors.

Note that (Doc, empty, union) is not a Monoid although union is
associative. This is because empty is an empty document, not an empty
list of documents. Also, union is not really mathematical union, but
cartesian product.

-}</font>

<font color=Blue>---------</font>
<font color=Blue>-- The rest is support code - not part of the expected exam answer.</font>
<u><font color="#804000">instance</font></u> <font color=Green>Monoid</font> <font color=Green>Doc</font> <u><font color="#804000">where</font></u>
  mempty <font color="#808080">=</font> empty
  mappend <font color="#808080">=</font> smartapp
  
smartapp <font color=Green>Empty</font> m <font color="#808080">=</font> m  
smartapp m <font color=Green>Empty</font> <font color="#808080">=</font> m
smartapp m n <font color="#808080">=</font> m <font color="#800080">&lt;&gt;</font> n


law1' <font color="#808080">(</font><font color="#800080">==</font><font color="#808080">)</font> z <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> m <font color="#808080">=</font>   <font color="#808080">(</font>z <font color="#800080">+</font> m<font color="#808080">)</font>  <font color="#800080">==</font>  m
law2' <font color="#808080">(</font><font color="#800080">==</font><font color="#808080">)</font> z <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> m <font color="#808080">=</font>   <font color="#808080">(</font>m <font color="#800080">+</font> z<font color="#808080">)</font>  <font color="#800080">==</font>  m
law3' <font color="#808080">(</font><font color="#800080">==</font><font color="#808080">)</font>   <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> m1 m2 m3 <font color="#808080">=</font> <font color="#808080">(</font><font color="#808080">(</font>m1 <font color="#800080">+</font> m2<font color="#808080">)</font> <font color="#800080">+</font> m3<font color="#808080">)</font>  <font color="#800080">==</font>  <font color="#808080">(</font>m1 <font color="#800080">+</font> <font color="#808080">(</font>m2 <font color="#800080">+</font> m3<font color="#808080">)</font><font color="#808080">)</font>

law1 e <font color="#808080">=</font> law1' e mempty mappend
law2 e <font color="#808080">=</font> law2' e mempty mappend
law3 <font color="#808080">::</font> <font color=Green>Monoid</font> t2 <font color="#808080">=&gt;</font> <font color="#808080">(</font>t2 <font color="#808080">-&gt;</font> t2 <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> t2 <font color="#808080">-&gt;</font> t2 <font color="#808080">-&gt;</font> t2 <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
law3 e <font color="#808080">=</font> law3' e        mappend

synEq <font color="#808080">::</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
synEq <font color="#808080">=</font> <font color="#808080">(</font><font color="#800080">==</font><font color="#808080">)</font> <font color=Blue>-- derived, syntactic equality</font>

semEq <font color="#808080">::</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Doc</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
semEq x y <font color="#808080">=</font> prettys x <font color="#800080">`bagEq`</font> prettys y

bagEq x y <font color="#808080">=</font> sort x <font color="#800080">==</font> sort y      
  <font color=Blue>-- The third monoid law does not hold for list equality.</font>
  <font color=Blue>-- This is because the sortBy only sorts down to length, not in more detail.</font>

<u><font color="#804000">instance</font></u> <font color=Green>Arbitrary</font> <font color=Green>Doc</font> <u><font color="#804000">where</font></u>
  arbitrary <font color="#808080">=</font> sized arbitraryDoc
  shrink <font color="#808080">=</font> shrinkDoc  

arbitraryDoc <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Gen</font> <font color=Green>Doc</font>  
arbitraryDoc n <font color="#808080">=</font> oneof <font color="#800080">$</font> basecase <font color="#800080">++</font> <u><font color="#804000">if</font></u> n <font color="#800080">==</font> <font color=Magenta>0</font> <u><font color="#804000">then</font></u> <font color=Green>[]</font> <u><font color="#804000">else</font></u> recurse
  <u><font color="#804000">where</font></u> basecase <font color="#808080">=</font> <font color="#808080">[</font>pure empty<font color="#808080">,</font> char <font color="#800080">&lt;$&gt;</font> arbitrary<font color="#808080">,</font> text <font color="#800080">&lt;$&gt;</font> arbitrary<font color="#808080">,</font> pure line<font color="#808080">]</font>
        recurse  <font color="#808080">=</font> <font color="#808080">[</font> <font color="#808080">(</font><font color="#800080">&lt;&gt;</font><font color="#808080">)</font>  <font color="#800080">&lt;$&gt;</font> arbitrary <font color="#800080">&lt;*&gt;</font> arbitrary
                   <font color="#808080">,</font> union <font color="#800080">&lt;$&gt;</font> arbitrary <font color="#800080">&lt;*&gt;</font> arbitrary
                   <font color="#808080">]</font>

shrinkDoc <font color=Green>Empty</font>        <font color="#808080">=</font> <font color=Green>[]</font>
shrinkDoc <font color="#808080">(</font><font color=Green>Char</font> <font color=Magenta>'x'</font><font color="#808080">)</font>   <font color="#808080">=</font> <font color="#808080">[</font><font color=Green>Empty</font><font color="#808080">]</font>
shrinkDoc <font color="#808080">(</font><font color=Green>Char</font> c<font color="#808080">)</font>     <font color="#808080">=</font> <font color="#808080">[</font><font color=Green>Empty</font><font color="#808080">,</font> <font color=Green>Char</font> <font color=Magenta>'x'</font><font color="#808080">]</font>
shrinkDoc <font color="#808080">(</font><font color=Green>Text</font> s<font color="#808080">)</font>     <font color="#808080">=</font> <font color=Green>Empty</font> <b><font color="#800080">:</font></b> map <font color=Green>Char</font> s <font color=Blue>-- ++ map Text (shrink s)</font>
shrinkDoc <font color=Green>Line</font>         <font color="#808080">=</font> <font color="#808080">[</font><font color=Green>Empty</font><font color="#808080">]</font>
shrinkDoc <font color="#808080">(</font><font color=Green>Concat</font> x y<font color="#808080">)</font> <font color="#808080">=</font> x <b><font color="#800080">:</font></b> y <b><font color="#800080">:</font></b> <font color="#808080">[</font><font color=Green>Concat</font> x' y <font color="#808080">|</font> x' <font color="#808080">&lt;-</font> shrink x<font color="#808080">]</font> 
                              <font color="#800080">++</font> <font color="#808080">[</font><font color=Green>Concat</font> x  y'<font color="#808080">|</font> y' <font color="#808080">&lt;-</font> shrink y<font color="#808080">]</font>
shrinkDoc <font color="#808080">(</font><font color=Green>Union</font>  x y<font color="#808080">)</font> <font color="#808080">=</font> x <b><font color="#800080">:</font></b> y <b><font color="#800080">:</font></b> <font color="#808080">[</font><font color=Green>Union</font> x' y <font color="#808080">|</font> x' <font color="#808080">&lt;-</font> shrink x<font color="#808080">]</font> 
                              <font color="#800080">++</font> <font color="#808080">[</font><font color=Green>Union</font> x  y'<font color="#808080">|</font> y' <font color="#808080">&lt;-</font> shrink y<font color="#808080">]</font>

main <font color="#808080">=</font> <u><font color="#804000">do</font></u> quickCheck <font color="#808080">(</font>law1 semEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>law2 semEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>law3 semEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>law1 synEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>law2 synEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>expectFailure <font color="#800080">$</font> law3 synEq<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>expectFailure <font color="#800080">$</font> law1' semEq empty union<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>expectFailure <font color="#800080">$</font> law2' semEq empty union<font color="#808080">)</font>
          quickCheck <font color="#808080">(</font>law3' semEq union<font color="#808080">)</font>

<font color=Blue>{- 

With list equality instead of bad equality, test3 is a simple test
case that fails.

*** Failed! Falsifiable (after 4 tests and 9 shrinks):  
-}</font>

test3 <font color="#808080">=</font> <u><font color="#804000">let</font></u> d1 <font color="#808080">=</font> <font color=Green>Union</font> <font color=Green>Empty</font> <font color=Green>Empty</font>     
            d2 <font color="#808080">=</font> <font color=Green>Union</font> <font color="#808080">(</font><font color=Green>Char</font> <font color=Magenta>'x'</font><font color="#808080">)</font> <font color=Green>Empty</font>
            d3 <font color="#808080">=</font> <font color=Green>Union</font> <font color="#808080">(</font><font color=Green>Char</font> <font color=Magenta>'y'</font><font color="#808080">)</font> <font color=Green>Empty</font>
            lhs <font color="#808080">=</font> prettys <font color="#800080">$</font> <font color="#808080">(</font>d1<font color="#800080">&lt;&gt;</font>d2<font color="#808080">)</font><font color="#800080">&lt;&gt;</font>d3
            rhs <font color="#808080">=</font> prettys <font color="#800080">$</font> d1<font color="#800080">&lt;&gt;</font><font color="#808080">(</font>d2<font color="#800080">&lt;&gt;</font>d3<font color="#808080">)</font>
        <u><font color="#804000">in</font></u> <font color="#808080">(</font>law3 semEq d1 d2 d3<font color="#808080">,</font> lhs<font color="#808080">,</font> rhs<font color="#808080">)</font>

</pre>
</body>
</html>